# 照片水印工具 (Photo Watermark Tool)

专业级照片水印添加工具，支持GUI图形界面和命令行操作。从图片EXIF信息中提取拍摄日期，在图片上添加高度可自定义的日期水印，支持多种格式和完整的导出控制。

## ✨ 功能特点

### 🖥️ **双模式操作**
- **GUI图形界面**：直观的拖拽操作，可视化参数设置
- **命令行界面**：批量处理，脚本自动化支持

### 📸 **智能日期提取**
- **EXIF拍摄日期**：自动从JPEG、TIFF等格式中读取原始拍摄时间
- **智能备选**：PNG、BMP等格式使用文件修改时间
- **格式兼容**：支持多种EXIF标准和日期格式

### 🎨 **高度可定制**
- **水印样式**：字体大小、颜色、位置、透明度全面可调
- **位置控制**：9个预设位置 + 中英文位置名称支持
- **视觉效果**：支持半透明水印和渐变效果
- **水印类型**：支持文本水印和图片水印
- **文本水印**：自定义文本、字体样式（粗体、斜体）、阴影和描边效果
- **图片水印**：支持PNG透明通道、缩放和透明度调节
- **旋转功能**：支持水印任意角度旋转（-180°到180°）

### 📁 **强大的文件处理**
- **拖拽导入**：支持图片和文件夹的直接拖拽
- **批量选择**：文件选择器批量导入多张图片
- **递归处理**：自动处理文件夹内所有支持的图片

### 🔄 **全面格式支持**
- **输入格式**：JPEG, PNG, BMP, TIFF, WebP, GIF, ICO
- **输出格式**：用户可选择JPEG或PNG输出
- **透明支持**：PNG格式完整支持透明通道
- **质量控制**：JPEG质量可调（1-100）

### 📤 **专业导出控制**
- **输出目录**：用户指定输出位置，防止覆盖原图
- **命名规则**：保留原名、添加前缀、添加后缀三种选择
- **尺寸调整**：按宽度、高度、百分比缩放图片
- **安全验证**：自动防止导出到原文件夹

### 🛡️ **安全可靠**
- **原图保护**：永不修改原始文件
- **错误处理**：完善的异常处理和用户提示
- **进度显示**：实时显示处理进度和状态

## 🚀 快速开始

### 环境要求
- **Python 3.7+**
- **操作系统**：Windows, macOS, Linux

### 安装依赖

```bash
pip install -r requirements.txt
```

或手动安装：

```bash
pip install Pillow>=10.0.0 piexif>=1.1.3 click>=8.0.0 tkinterdnd2>=0.3.0
```

### 运行方式

#### 🖥️ **GUI图形界面（推荐）**

```bash
python gui_app.py
```

**功能亮点**：
- 🖱️ 拖拽导入图片或文件夹
- 📁 文件选择器批量导入
- ⚙️ 可视化参数设置面板
- 📈 实时处理进度显示
- 📤 完整的导出控制选项
- 🎨 颜色调色板选择器：点击🎨按钮打开颜色选择器，直观选择水印颜色

#### 💻 **命令行界面**

基本用法：
```bash
# 处理单张图片
python main.py "/path/to/photo.jpg"

# 处理整个文件夹
python main.py "/path/to/photos"
```

高级用法：
```bash
# 完整参数示例
python main.py test_photos \
  --output-dir "output_custom" \
  --font-size 48 \
  --color "#FF0000" \
  --position "top_right" \
  --opacity 0.8 \
  --output-format "png" \
  --jpeg-quality 95 \
  --naming-rule "prefix" \
  --custom-prefix "wm_" \
  --resize-mode "percent" \
  --resize-percent 0.5
```

图片水印用法：
```bash
# 使用图片水印
python main.py test_photos \
  --image-watermark "logo.png" \
  --image-watermark-scale 0.5 \
  --opacity 0.7 \
  --position "bottom_right"

# 自定义文本水印
python main.py test_photos \
  --custom-text "公司机密" \
  --bold \
  --shadow \
  --font-size 60 \
  --color "#0000FF"
```

旋转功能用法：
```
# 文本水印旋转45度
python main.py test_photos \
  --custom-text "旋转水印" \
  --rotation 45 \
  --font-size 48 \
  --color "#FF0000"

# 图片水印旋转90度
python main.py test_photos \
  --image-watermark "logo.png" \
  --rotation 90 \
  --image-watermark-scale 0.5
```

## 📊 参数说明

### 基础参数
| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| `input_path` | - | - | 输入图片文件路径或目录路径（必需） |
| `--font-size` | `-s` | 36 | 水印字体大小 |
| `--color` | `-c` | #FFFFFF | 水印文字颜色（十六进制格式） |
| `--position` | `-p` | bottom_right | 水印位置 |
| `--font-path` | `-f` | None | 自定义字体文件路径 |
| `--opacity` | `-o` | 1.0 | 水印透明度（0.0-1.0） |

### 格式控制参数
| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| `--output-format` | `-of` | auto | 输出格式 (auto/jpeg/png) |
| `--jpeg-quality` | `-jq` | 95 | JPEG质量 (1-100) |

### 文本水印参数
| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| `--custom-text` | `-ct` | None | 自定义水印文本 |
| `--bold` | `-b` | False | 使用粗体字体 |
| `--italic` | `-i` | False | 使用斜体字体 |
| `--shadow` | `-sh` | False | 添加阴影效果 |
| `--stroke` | `-st` | False | 添加描边效果 |

### 图片水印参数
| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| `--image-watermark` | `-iw` | None | 图片水印文件路径 |
| `--image-watermark-scale` | `-iws` | 1.0 | 图片水印缩放比例 (0.1-3.0) |
| `--rotation` | `-r` | 0.0 | 水印旋转角度 (-180.0到180.0度) |

### 导出控制参数
| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| `--output-dir` | `-od` | None | 输出目录路径 |
| `--naming-rule` | `-nr` | suffix | 文件命名规则 (original/prefix/suffix) |
| `--custom-prefix` | `-cp` | wm_ | 自定义前缀 |
| `--custom-suffix` | `-cs` | _watermarked | 自定义后缀 |

### 尺寸调整参数
| 参数 | 简写 | 默认值 | 说明 |
|------|------|--------|------|
| `--resize-mode` | `-rm` | none | 缩放模式 (none/width/height/percent) |
| `--resize-width` | `-rw` | 800 | 目标宽度像素 |
| `--resize-height` | `-rh` | 600 | 目标高度像素 |
| `--resize-percent` | `-rp` | 1.0 | 缩放百分比 (0.1-3.0) |

## 支持的水印位置

### 英文位置名称
- `top_left` - 左上角
- `top_center` - 上方居中
- `top_right` - 右上角
- `center_left` - 左侧居中
- `center` - 正中央
- `center_right` - 右侧居中
- `bottom_left` - 左下角
- `bottom_center` - 下方居中
- `bottom_right` - 右下角（默认）

### 中文位置名称
- `左上`、`上中`、`右上`
- `左中`、`居中`、`右中`
- `左下`、`下中`、`右下`

## 项目结构

```
NJUSE25FALL-Photo-Watermark/
├── src/
│   ├── __init__.py
│   ├── exif_reader.py         # EXIF信息读取模块（支持多格式）
│   └── watermark_processor.py # 水印处理核心模块
├── examples/                  # 示例图片目录
├── main.py                   # 命令行主程序入口
├── gui_app.py               # GUI图形界面主程序
├── run_gui.py               # IDE运行入口脚本
├── run_cli.py               # 命令行测试脚本
├── test_app.py              # 基础功能测试
├── test_export_features.py  # 导出功能测试
├── requirements.txt         # Python依赖
├── .vscode/                 # VS Code配置
├── .gitignore
└── README.md
```

## 快速测试

### 基础功能测试
运行基础测试脚本来创建示例图片并验证功能：

```bash
python test_app.py
```

### GUI界面快速测试
直接启动图形界面进行测试：

```bash
python run_gui.py
```

### 导出功能完整测试
测试所有新增的导出控制功能：

```bash
python test_export_features.py
```

### 命令行参数测试
运行命令行参数示例：

```bash
python run_cli.py
```

**测试内容包括**：
1. 创建带有EXIF信息的测试图片（JPEG、PNG、BMP、TIFF等格式）
2. 验证拖拽导入和批量处理功能（GUI）
3. 测试格式转换和透明通道处理
4. 验证导出控制、命名规则和尺寸调整
5. 在`examples`目录下生成各种测试结果

### 图片水印功能测试
测试新增的图片水印功能：

```bash
python test_image_watermark.py
```

### 自定义文本水印功能测试
测试新增的自定义文本水印功能：

```bash
python test_custom_watermark.py
```

## 工作原理

### 核心处理流程
1. **文件发现**：递归扫描输入路径，识别所有支持的图片格式
2. **EXIF分析**：智能读取各种格式的元数据信息
3. **日期提取**：优先使用EXIF拍摄时间，备选文件修改时间
4. **图片处理**：支持格式转换、透明通道、尺寸调整
5. **水印绘制**：高质量文本渲染，支持透明度和位置控制
6. **安全输出**：防覆盖保护，自定义命名规则，质量控制

### GUI处理特点
- **多线程架构**：UI响应与图片处理分离，避免界面卡顿
- **实时反馈**：进度条显示处理状态，实时错误提示
- **批量优化**：大文件夹自动分批处理，内存使用优化

### 安全机制
- **原图保护**：永不修改原始文件
- **路径验证**：防止输出到原文件夹
- **错误隔离**：单张图片失败不影响整体处理
- **格式兼容**：自动处理不同格式的特殊情况

## 支持格式

### 输入格式（自动识别）
- **JPEG**：`.jpg`, `.jpeg` - 完整EXIF支持
- **PNG**：`.png` - 支持透明通道，使用文件时间
- **BMP**：`.bmp` - 使用文件修改时间
- **TIFF**：`.tiff`, `.tif` - 完整EXIF支持
- **WebP**：`.webp` - 现代Web图片格式
- **GIF**：`.gif` - 动画图片首帧处理
- **ICO**：`.ico` - Windows图标格式

### 输出格式（用户可选）
- **JPEG**：高压缩比，质量可调（1-100）
- **PNG**：无损压缩，支持透明通道
- **自动模式**：保持与原文件相同的格式

### EXIF支持详情
- **完整支持**：JPEG、TIFF格式读取原始拍摄时间
- **备选方案**：PNG、BMP等格式使用文件修改时间
- **安全处理**：自动处理损坏或缺失的EXIF数据

## 使用建议与注意事项

### 💡 使用建议
- **首次使用**：建议先用GUI界面熟悉功能，再使用命令行批量处理
- **大批量处理**：使用命令行模式，性能更优，支持脚本自动化
- **参数调试**：先用小批量图片测试水印效果，确定最佳参数
- **格式选择**：JPEG适合照片，PNG适合需要透明效果的图片

### ⚠️ 重要提醒
- **原图安全**：程序永不修改原始图片文件
- **输出保护**：默认禁止导出到原文件夹，防止意外覆盖
- **路径规范**：建议使用绝对路径，避免路径解析问题
- **依赖环境**：确保安装所有必需的Python包

### 📋 格式说明
- **EXIF信息**：JPEG、TIFF格式支持完整的拍摄时间读取
- **透明通道**：PNG格式完整保持透明效果
- **文件命名**：支持三种命名规则，默认添加后缀防止冲突
- **质量控制**：JPEG输出质量可调，平衡文件大小与画质

### 🔧 常见问题
- **依赖安装**：如遇到导入错误，请检查requirements.txt中的包是否安装完整
- **路径问题**：Windows用户注意路径分隔符，建议使用正斜杠或双反斜杠
- **内存使用**：处理大量高分辨率图片时，程序会自动优化内存使用
- **GUI响应**：大批量处理时界面可能暂时无响应，这是正常现象

## 开发信息

- **版本**：2.1.0
- **作者**：Hanke
- **Python版本要求**：3.7+
- **主要依赖**：
  - `Pillow>=10.0.0` - 图像处理核心库
  - `piexif>=1.1.3` - EXIF信息读取
  - `click>=8.0.0` - 命令行界面
  - `tkinterdnd2>=0.3.0` - GUI拖拽功能

### 🆕 版本更新记录
**v2.1.0** (当前版本)
- ✅ 新增图片水印功能，支持PNG透明通道
- ✅ 新增自定义文本水印，支持字体样式（粗体、斜体）
- ✅ 新增文本效果（阴影、描边）
- ✅ 支持图片水印缩放和透明度调节
- ✅ 完善GUI界面，添加图片水印设置面板

**v2.0.0**
- ✅ 新增GUI图形界面，支持拖拽操作
- ✅ 扩展格式支持：BMP、TIFF、WebP、GIF、ICO
- ✅ 完整的导出控制：输出目录、命名规则、质量调节
- ✅ 图片尺寸调整功能
- ✅ PNG透明通道完整支持
- ✅ 多线程处理优化
- ✅ 安全机制增强

**v1.0.0** (基础版本)
- ✅ 基础命令行水印功能
- ✅ EXIF日期读取
- ✅ JPEG、PNG基础支持

## 许可证

本项目采用MIT许可证，详见LICENSE文件。
